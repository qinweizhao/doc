# ElasticJob

## 一、简介

ElasticJob 是面向互联网生态和海量任务的分布式调度解决方案，由两个相互独立的子项目 ElasticJob-Lite 和 ElasticJob-Cloud 组成。 它通过弹性调度、资源管控、以及作业治理的功能，打造一个适用于互联网场景的分布式调度解决方案，并通过开放的架构设计，提供多元化的作业生态。 它的各个产品使用统一的作业 API，开发者仅需一次开发，即可随意部署。

### 1、ElasticJob-Lite

定位为轻量级无中心化解决方案，使用 jar 的形式提供分布式任务的协调服务。

![2022-11-14_143312](https://img.qinweizhao.com/2022/11/2022-11-14_143312.png)

### 2、ElasticJob-Cloud

采用自研 Mesos Framework 的解决方案，额外提供资源治理、应用分发以及进程隔离等功能。

![2022-11-14_143429](https://img.qinweizhao.com/2022/11/2022-11-14_143429.png)

|          | ElasticJob-Lite | ElasticJob-Cloud  |
| -------- | --------------- | ----------------- |
| 无中心化 | 是              | 否                |
| 资源分配 | 不支持          | 支持              |
| 作业模式 | 常驻            | 常驻 + 瞬时       |
| 部署依赖 | ZooKeeper       | ZooKeeper + Mesos |

ElasticJob‐Cloud 的优势在于对资源细粒度治理，适用于需要削峰填谷的大数据系统。

## 二、功能

### 1、弹性调度

弹性调度是 ElasticJob 最重要的功能，也是这款产品名称的由来。它是一款能够让任务通过分片进行水平扩展的任务处理系统。

#### 1.1、分片

ElasticJob 中任务分片项的概念，使得任务可以在分布式的环境下运行，每台任务服务器只运行分配给该服务器的分片。随着服务器的增加或宕机，ElasticJob 会近乎实时的感知服务器数量的变更，从而重新为分布式的任务服务器分配更加合理的任务分片项，使得任务可以随着资源的增加而提升效率。任务的分布式执行，需要将一个任务拆分为多个独立的任务项，然后由分布式的服务器分别执行某一个或几个分片项。例如：如果作业分为 4 片，用两台服务器执行，则每个服务器分到 2 片，分别负责作业的 50% 的负载。

ElasticJob 并不直接提供数据处理的功能，而是将分片项分配至各个运行中的作业服务器，开发者需要自行处理分片项与业务的对应关系。分片项为数字（从 0 开始）。

个性化参数可以和分片项匹配对应关系，用于将分片项的数字转换为更加可读的业务代码。例如：按照地区水平拆分数据库，数据库 A 是北京的数据；数据库 B 是上海的数据；数据库 C 是广州的数据。如果仅按照分片项配置，开发者需要了解 0 表示北京；1 表示上海；2 表示广州。合理使用个性化参数可以让代码更可读，如果配置为 0= 北京，1= 上海，2= 广州，那么代码中直接使用北京，上海，广州的枚举值即可完成分片项和业务逻辑的对应关系。

#### 1.2、资源最大限度利用

ElasticJob 提供最灵活的方式，最大限度的提高执行作业的吞吐量。当新增加作业服务器时，ElasticJob 会通过注册中心的临时节点的变化感知到新服务器的存在，并在下次任务调度的时候重新分片，新的服务器会承载一部分作业分片。

建议将分片项设置为大于服务器的数量，最好是大于服务器倍数的数量，作业将会合理的利用分布式资源，动态的分配分片项。例如：3 台服务器，分成 10 片，则分片项分配结果为服务器 A = 0,1,2,9；服务器 B = 3,4,5；服务器 C = 6,7,8。如果服务器 C 崩溃，则分片项分配结果为服务器 A = 0,1,2,3,4; 服务器 B = 5,6,7,8,9。在不丢失分片项的情况下，最大限度的利用现有资源提高吞吐量。

#### 1.3、高可用

当作业服务器在运行中宕机时，注册中心同样会通过临时节点感知，并将在下次运行时将分片转移至仍存活的服务器，以达到作业高可用的效果。本次由于服务器宕机而未执行完的作业，则可以通过失效转移的方式继续执行。

将分片总数设置为 1，并使用多于 1 台的服务器执行作业，作业将会以 1 主 n 从的方式执行。一旦执行作业的服务器宕机，等待执行的服务器将会在下次作业启动时替补执行。开启失效转移功能效果更好，如果本次作业在执行过程中宕机，备机会立即替补执行。

### 2、资源分配

资源分配功能为 ElasticJob‐Cloud 所特有的功能。

- 在适合的时间将适合的资源分配给任务并使其生效
- 相同任务聚合至相同的执行器统一处理
-  动态调配追加资源至新分配的任务
#### 2.1、作业运行模式

ElasticJob‐Cloud 分为瞬时作业和常驻作业 2 种运行模式。

- 瞬时作业

在每一次作业执行完毕后立刻释放资源，保证利用现有资源错峰执行。资源分配和容器启动均占用一定时长，且作业执行时资源不一定充足，因此作业执行会有延迟。瞬时作业适用于间隔时间长，资源消耗多且对执行时间无严格要求的作业。

- 常驻作业

无论在运行时还是等待运行时，均一直占用分配的资源，可节省过多容器启动和资源分配的开销，适用于间隔时间短，资源需求量稳定的作业。

#### 2.2、调度器

ElasticJob‐Cloud 基于 Mesos 的 Framework 开发，用于资源调度和应用分发，需要独立启动并提供服务。

#### 2.3、作业应用

指作业打包部署后的应用，描述了作业启动需要用到的 CPU、内存、启动脚本及应用下载路径等基本信息。每个作业应用可以包含一个或多个作业。

#### 2.4、作业

即实际运行的具体任务，和 ElasticJob‐Lite 共用同样的作业生态。在注册作业之前必须先注册作业应用。

#### 2.5、资源

指作业启动或运行需要用到的 CPU、内存。配置在作业应用维度表示整个应用启动需要用的资源；配置在作业维度表示每个作业运行需要的资源。作业启动需要的资源为指定作业应用需要的资源与作业需要资源的总和。

### 3、作业治理

#### 3.1、失效转移

ElasticJob 不会在本次执行过程中进行重新分片，而是等待下次调度之前才开启重新分片流程。当作业执行过程中服务器宕机，失效转移允许将该次未完成的任务在另一作业节点上补偿执行。

**概念**

失效转移是当前执行作业的临时补偿执行机制，在下次作业运行时，会通过重分片对当前作业分配进行调整。举例说明，若作业以每小时为间隔执行，每次执行耗时 30 分钟。

![2022-11-16_142335](https://img.qinweizhao.com/2022/11/2022-11-16_142335.png)

图中表示作业分别于 12:00，13:00 和 14:00 执行。图中显示的当前时间点为 13:00 的作业执行中。

如果作业的其中一个分片服务器在 13:10 的时候宕机，那么剩余的 20 分钟应该处理的业务未得到执行， 并且需要在 14:00 时才能再次开始执行下一次作业。也就是说，在不开启失效转移的情况下，位于该分片 的作业有 50 分钟空档期。如下如图所示。

![2022-11-16_142917](https://img.qinweizhao.com/2022/11/2022-11-16_142917.png)

在开启失效转移功能之后，ElasticJob 的其他服务器能够在感知到宕机的作业服务器之后，补偿执行该分片作业。如下图所示。

![2022-11-16_143112](https://img.qinweizhao.com/2022/11/2022-11-16_143112.png)

在资源充足的情况下，作业仍然能够在 13:30 完成执行。

**执行机制**

当作业执行节点宕机时，会触发失效转移流程。ElasticJob 根据触发时的分布式作业执行的不同状况来决 定失效转移的执行时机。

通知执行：当其他服务器感知到有失效转移的作业需要处理时，且该作业服务器已经完成了本次任务，则会实时的 拉取待失效转移的分片项，并开始补偿执行。也称为实时执行。

问询执行：作业服务在本次任务执行结束后，会向注册中心问询待执行的失效转移分片项，如果有，则开始补偿执 行。也称为异步执行。

**适用场景**

开启失效转移功能，ElasticJob 会监控作业每一分片的执行状态，并将其写入注册中心，供其他节点感知。

在一次运行耗时较长且间隔较长的作业场景，失效转移是提升作业运行实时性的有效手段；对于间隔较短的作业，会产生大量与注册中心的网络通信，对集群的性能产生影响。而且间隔较短的作业并未见得 关注单次作业的实时性，可以通过下次作业执行的重分片使所有的分片正确执行，因此不建议短间隔作 业开启失效转移。

注意：作业本身的幂等性，是保证失效转移正确性的前提。

#### 3.2、错过任务重执行

ElasticJob 不允许作业在同一时间内叠加执行。当作业的执行时长超过其运行间隔，错过任务重执行能够保证作业在完成上次的任务后继续执行逾期的作业。

**概念**

错过任务重执行功能可以使逾期未执行的作业在之前作业执行完成之后立即执行。举例说明，若作业以每小时为间隔执行，每次执行耗时 30 分钟。

![2022-11-16_143657](https://img.qinweizhao.com/2022/11/2022-11-16_143657.png)

图中表示作业分别于 12:00，13:00 和 14:00 执行。图中显示的当前时间点为 13:00 的作业执行中。

如果 12：00 开始执行的作业在 13:10 才执行完毕，那么本该由 13:00 触发的作业则错过了触发时间，需要等待至 14:00 的下次作业触发。

![2022-11-16_143738](https://img.qinweizhao.com/2022/11/2022-11-16_143738.png)

在开启错过任务重执行功能之后，ElasticJob 将会在上次作业执行完毕后，立刻触发执行错过的作业。

![2022-11-16_143759](https://img.qinweizhao.com/2022/11/2022-11-16_143759.png)

在 13：00 和 14:00 之间错过的作业将会重新执行。

**适用场景**

在一次运行耗时较长且间隔较长的作业场景，错过任务重执行是提升作业运行实时性的有效手段；对于未见得关注单次作业的实时性的短间隔的作业来说，开启错过任务重执行并无必要。

### 4、作业开放生态

灵活定制化作业是 ElasticJob 3.x 版本的最重要设计变革。新版本基于 Apache ShardingSphere 可插拔架构的设计理念，打造了全新作业 API。意在使开发者能够更加便捷且相互隔离的方式拓展作业类型，打造 ElasticJob 作业的生态圈。

ElasticJob 提供了对作业的弹性伸缩、分布式治理等功能的同时，并未限定作业的类型。它通过灵活的作业 API，将作业解耦为作业接口和执行器接口。用户可以定制化全新的作业类型，诸如脚本执行、HTTP 服务执行（3.0.0‐beta 提供）、大数据类作业、文件类作业等。目前 ElasticJob 内置了简单作业、数据流作 业和脚本执行作业，并且完全开放了扩展接口，开发者可以通过 SPI 的方式引入新的作业类型。

#### 4.1、作业接口

ElasticJob 的作业可划分为基于 class 类型和基于 type 类型两种。 Class 类型的作业由开发者直接使用，需要由开发者实现该作业接口实现业务逻辑。典型代表：Simple 类 型、Dataflow 类型。Type 类型的作业只需提供类型名称即可，开发者无需实现该作业接口，而是通过外 置配置的方式使用。典型代表：Script 类型、HTTP 类型。

#### 4.2、执行器接口

用于执行用户定义的作业接口，通过 Java 的 SPI 机制织入 ElasticJob 生态。

### 5、可视化管控端

ElasticJob 提供了一个运维平台，可以通过这个平台来动态管理定时任务，运维平台地址：

```http
https://github.com/apache/shardingsphere-elasticjob-ui
```

运维平台使用步骤：

构建：

```sh
git clone https://github.com/apache/shardingsphere-elasticjob-ui.git
cd shardingsphere-elasticjob-ui/
mvn clean package -Prelease
```

解压：

Lite：

```txt
shardingsphere-elasticjob-ui/shardingsphere-elasticjob-ui-distribution/shardingsphere-elasticjob-lite-ui-bin-distribution/target/apache-shardingsphere-${latest.release.version}-shardingsphere-elasticjob-lite-ui-bin.tar.gz
```

Cloud：

```txt
shardingsphere-elasticjob-ui/shardingsphere-elasticjob-ui-distribution/shardingsphere-elasticjob-cloud-ui-bin-distribution/target/apache-shardingsphere-${latest.release.version}-shardingsphere-elasticjob-cloud-ui-bin.tar.gz
```

执行：

bin 目录下的 startup.sh 脚本启动。

地址： `http://localhost:8088`，默认的用户名密码都是 root 。

![2022-11-16_160338](https://img.qinweizhao.com/2022/11/2022-11-16_160338.png)

## 三、原理

### 1、ElasticJob-Lite

ElasticJob‐Lite 并无作业调度中心节点，而是基于部署作业框架的程序在到达相应时间点时各自触发调 度。注册中心仅用于作业注册和监控信息存储。而主作业节点仅用于处理分片和清理等功能。

#### 1.1、弹性分布式实现

- 第一台服务器上线触发主服务器选举。主服务器一旦下线，则重新触发选举，选举过程中阻塞，只 有主服务器选举完成，才会执行其他任务。

- 某作业服务器上线时会自动将服务器信息注册到注册中心，下线时会自动更新服务器状态。

- 主节点选举，服务器上下线，分片总数变更均更新重新分片标记。

- 定时任务触发时，如需重新分片，则通过主服务器分片，分片过程中阻塞，分片结束后才可执行任 务。如分片过程中主服务器下线，则先选举主服务器，再分片。

- 通过上一项说明可知，为了维持作业运行时的稳定性，运行过程中只会标记分片状态，不会重新分 片。分片仅可能发生在下次任务触发前。

- 每次分片都会按服务器 IP 排序，保证分片结果不会产生较大波动。

- 实现失效转移功能，在某台服务器执行完毕后主动抓取未分配的分片，并且在某台服务器下线后主 动寻找可用的服务器执行任务。

#### 1.2、注册中心数据结构

注册中心在定义的命名空间下，创建作业名称节点，用于区分不同作业，所以作业一旦创建则不能修改作 业名称，如果修改名称将视为新的作业。作业名称节点下又包含 5 个数据子节点，分别是 config、instances、sharding、 servers 和 leader。

- config 节点

作业配置信息，以 YAML 格式存储。

- instances 节点

作业运行实例信息，子节点是当前作业运行实例的主键。作业运行实例主键由作业运行服务器的 IP 地址 和 PID 构成。作业运行实例主键均为临时节点，当作业实例上线时注册，下线时自动清理。注册中心监 控这些节点的变化来协调分布式作业的分片以及高可用。可在作业运行实例节点写入 TRIGGER 表示该 实例立即执行一次。

- sharding 节点

作业分片信息，子节点是分片项序号，从零开始，至分片总数减一。分片项序号的子节点存储详细信息。 每个分片项下的子节点用于控制和记录分片运行状态。节点详细信息说明：

| 子节点 名  | 临时节 点 | 描述                                                         |
| ---------- | --------- | ------------------------------------------------------------ |
| in‐ stance | 否        | 执行该分片项的作业运行实例主键                               |
| run‐ ning  | 是        | 分片项正在运行的状态仅配置 monitorExecution 时有效           |
| failover   | 是        | 如果该分片项被失效转移分配给其他作业服务器，则此节点值记录执行此分片的 作业服务器 IP |
| misfire    | 否        | 是否开启错过任务重新执行                                     |
| dis‐ abled | 否        | 是否禁用此分片项                                             |

- servers 节点

作业服务器信息，子节点是作业服务器的 IP 地址。可在 IP 地址节点写入 DISABLED 表示该服务器禁用。 在新的云原生架构下，servers 节点大幅弱化，仅包含控制服务器是否可以禁用这一功能。为了更加纯粹 的实现作业核心，servers 功能未来可能删除，控制服务器是否禁用的能力应该下放至自动化部署系统。

- leader 节点

作业服务器主节点信息，分为 election，sharding 和 failover 三个子节点。分别用于主节点选举，分片和失效转移处理。

leader 节点是内部使用的节点，如果对作业框架原理不感兴趣，可不关注此节点。

| 子节点名                                         | 临 时 节 点 | 描述                                                         |
| ------------------------------------------------ | ----------- | ------------------------------------------------------------ |
| election:r aw‐ latex:‘ instance‘                 | 是          | 主节点服务器 IP 地址一旦该节点被删除将会触发重新选举重新选举的过程 中一切主节点相关的操作都将阻塞 |
| electio n:raw‐ late x:latch                      | 否          | 主节点选举的分布式锁为 curator 的分布式锁使用                |
| s harding:ra w‐ latex:necessary                  | 否          | 是否需要重新分片的标记如果分片总数变化，或作业服务器节点上下线或启 用/禁用，以及主节点选举，会触发设置重分片标记作业在下次执行时使用主 节点重新分片，且中间不会被打断作业执行时不会触发分片 |
| sh arding:raw ‐ latex:p rocessing                | 是          | 主节点在分片时持有的节点如果有此节点，所有的作业执行都将阻塞，直至 分片结束主节点分片结束或主节点崩溃会删除此临时节点 |
| failove r:raw‐ late x:items :raw‐latex : 分 片项 | 否          | 一旦有作业崩溃，则会向此节点记录当有空闲作业服务器时，会从此节点抓 取需失效转移的作业项 |
| failov er:raw‐ lat ex:items ‘:raw_late x:latch‘  | 否          | 分配失效转移分片项时占用的分布式锁为 curator 的分布式锁使用  |

#### 1.3、流程图

**作业启动**

![2022-11-16_152700](https://img.qinweizhao.com/2022/11/2022-11-16_152700.png)

**作业执行**

![2022-11-16_152736](https://img.qinweizhao.com/2022/11/2022-11-16_152736.png)
